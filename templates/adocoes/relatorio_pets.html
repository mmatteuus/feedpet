{% extends 'base.html' %}

{% block title %}{{ page_title }} - FeedPet{% endblock %}

{% block extra_css %}
<style>
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1.5rem;
  }
  @media (min-width: 992px) {
    .dashboard-grid { grid-template-columns: repeat(3, 1fr); }
    .grid-col-span-2 { grid-column: span 2 / span 2; }
  }

  /* Cards de Estatísticas (KPIs) */
  .stat-card {
    background-color: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
    animation: fadeInUp 0.5s ease-out forwards;
    opacity: 0;
  }
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
    border-color: rgba(var(--primary-rgb), .25);
  }
  .stat-card .icon {
    width: 50px; height: 50px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; color: #fff;
  }
  .stat-card .stat-number {
    font-family: 'Poppins', sans-serif;
    font-weight: 700; font-size: 2.15rem; line-height: 1;
    color: var(--text-primary);
  }
  .stat-card .stat-label {
    font-weight: 500; color: var(--text-secondary);
  }
  /* Cores específicas para os cards */
  .stat-card.pendente .icon { background-color: var(--warning); }
  .stat-card.disponivel .icon { background-color: var(--success); }
  .stat-card.em_processo .icon { background-color: var(--info); }
  .stat-card.adotado .icon { background-color: #6b7280; }

  /* Card do Gráfico e Tabela */
  .chart-card, .table-card {
    background-color: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    animation: fadeInUp 0.5s ease-out forwards;
    opacity: 0;
  }
  #petStatusChart { max-height: 300px; }

  /* Abas de Navegação (Pills) */
  .nav-pills .nav-link {
    border-radius: var(--radius);
    font-weight: 500;
    color: var(--text-primary);
  }
  .nav-pills .nav-link.active {
    background-color: var(--primary);
    color: #fff;
    box-shadow: var(--shadow-sm);
  }
  .nav-pills .nav-link:focus-visible {
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), .3);
    outline: none;
  }

  /* Tabela Aprimorada */
  .table-hover tbody tr:hover { background-color: rgba(var(--primary-rgb), 0.05); }
  .table .pet-avatar {
    width: 45px; height: 45px; object-fit: cover;
    border-radius: 50%; border: 2px solid var(--border);
  }

  /* Animação */
  @keyframes fadeInUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  @media (prefers-reduced-motion: reduce) {
    .stat-card, .chart-card, .table-card { animation: none; opacity: 1; }
  }

  /* Dark mode coerente (usa variáveis do base) */
  [data-theme="dark"] .table .pet-avatar { border-color: var(--border); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 fw-bold mb-0">Dashboard de Relatórios</h1>
    <a href="{% url 'adicionar_pet' %}" class="btn btn-primary">
      <i class="bi bi-plus-circle me-1" aria-hidden="true"></i> Adicionar Pet
    </a>
  </div>

  <!-- KPIs -->
  <div class="row g-4 mb-4">
    {% for status_key, count in counts.items %}
      <div class="col-xl-3 col-md-6">
        <div class="stat-card {{ status_key }}" style="animation-delay: {% widthratio forloop.counter0 1 100 %}ms;">
          <div class="icon" aria-hidden="true">
            {% if status_key == 'pendente' %}<i class="bi bi-hourglass-split"></i>{% endif %}
            {% if status_key == 'disponivel' %}<i class="bi bi-heart-fill"></i>{% endif %}
            {% if status_key == 'em_processo' %}<i class="bi bi-arrow-repeat"></i>{% endif %}
            {% if status_key == 'adotado' %}<i class="bi bi-house-heart-fill"></i>{% endif %}
          </div>
          <div>
            <div class="stat-number">{{ count }}</div>
            <div class="stat-label">{{ status_key|default:"Status"|capfirst }}</div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="row g-4">
    <!-- Gráfico -->
    <div class="col-lg-4">
      <div class="chart-card p-3" style="animation-delay: 500ms;">
        <h5 class="card-title fw-bold p-2">Distribuição por Status</h5>
        <div style="position: relative; height: 320px;">
          <canvas id="petStatusChart" aria-label="Gráfico de distribuição por status" role="img"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabela -->
    <div class="col-lg-8">
      <div class="table-card" style="animation-delay: 600ms;">
        <div class="p-3">
          <ul class="nav nav-pills nav-fill" role="tablist" aria-label="Filtros por status">
            {% for value, label in status_choices %}
              <li class="nav-item" role="presentation">
                <a class="nav-link {% if value == current_status %}active{% endif %}"
                   href="{% url 'relatorio_pets' %}?status={{ value }}"
                   aria-current="{% if value == current_status %}page{% else %}false{% endif %}">
                  {{ label }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
        <div class="card-body p-0">
          {% if pets %}
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col" class="p-3">Pet</th>
                    <th scope="col">Solicitante</th>
                    <th scope="col">Status</th>
                    <th scope="col">Última Atualização</th>
                    <th scope="col" class="text-end">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for pet in pets %}
                  <tr>
                    <td class="p-3">
                      <div class="d-flex align-items-center">
                        <img src="{{ pet.foto_principal.url }}" alt="Avatar de {{ pet.nome }}" class="pet-avatar me-3" loading="lazy" referrerpolicy="no-referrer">
                        <div>
                          <div class="fw-bold">{{ pet.nome }}</div>
                          <div class="text-muted small">{{ pet.get_especie_display }}</div>
                        </div>
                      </div>
                    </td>
                    <td>{{ pet.solicitante.username|default:"Admin" }}</td>
                    <td>
                      <span class="badge rounded-pill 
                        {% if pet.status == 'PENDENTE' %}text-bg-warning{% endif %}
                        {% if pet.status == 'DISPONIVEL' %}text-bg-success{% endif %}
                        {% if pet.status == 'EM_PROCESSO' %}text-bg-info{% endif %}
                        {% if pet.status == 'ADOTADO' %}text-bg-secondary{% endif %}">
                        {{ pet.get_status_display }}
                      </span>
                    </td>
                    <td>{{ pet.data_atualizacao|date:"d M, Y" }}</td>
                    <td class="text-end">
                      <a href="{{ pet.get_absolute_url }}" class="btn btn-sm btn-outline-secondary" title="Ver Detalhes" aria-label="Ver detalhes de {{ pet.nome }}">
                        <i class="bi bi-eye-fill" aria-hidden="true"></i>
                      </a>
                      <a href="{% url 'editar_pet' pet.slug %}" class="btn btn-sm btn-outline-primary" title="Editar" aria-label="Editar {{ pet.nome }}">
                        <i class="bi bi-pencil-fill" aria-hidden="true"></i>
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center p-5">
              <i class="bi bi-search fs-1 text-muted" aria-hidden="true"></i>
              <h5 class="mt-3">Nenhum pet encontrado</h5>
              <p class="text-muted">Não há pets com o status "{{ current_status|capfirst }}" no momento.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('petStatusChart');
  if (!canvas || typeof Chart === 'undefined') return;

  // counts como JSON seguro via json_script
  const chartDataEl = document.getElementById('chart-data');
  let chartData = {};
  if (chartDataEl) {
    try { chartData = JSON.parse(chartDataEl.textContent); } catch (e) { chartData = {}; }
  }

  const labels = Object.keys(chartData).map(k => k.charAt(0).toUpperCase() + k.slice(1));
  const data = Object.values(chartData);

  // Paleta coerente com os status do loop principal (ordem: pendente, disponivel, em_processo, adotado)
  const colors = ['#F59E0B', '#10B981', '#3B82F6', '#6B7280'];

  new Chart(canvas, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        label: 'Nº de Pets',
        data,
        backgroundColor: colors.slice(0, data.length),
        borderColor: '#ffffff',
        borderWidth: 2,
        hoverOffset: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { padding: 20, usePointStyle: true, pointStyle: 'circle' }
        },
        tooltip: {
          callbacks: {
            label: (context) => {
              const label = context.label ? context.label + ': ' : '';
              const val = context.parsed ?? 0;
              return label + val + ' pet(s)';
            }
          }
        }
      },
      cutout: '65%'
    }
  });
});
</script>

{# Export seguro dos dados do gráfico #}
{{ counts|json_script:"chart-data" }}
{% endblock %}